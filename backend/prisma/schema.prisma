datasource db {
  provider = "postgresql"
  relationMode = "prisma"
}

enum EstadoRobot {
  OCUPADO
  MANTENIMIENTO
  LIBRE
}

enum Ubicaciones {
  BLOQUE_C
  BLOQUE_B
  PUERTA_1
  PUNTO_ESPERA
  SALIDA
}

generator client {
  provider = "prisma-client-js"
}

model Route {
  id        Int      @id @default(autoincrement())
  name      String
  points    Json
  beginning Ubicaciones
  ending    Ubicaciones
  createdAt DateTime @default(now())
  
  // Relaciones inversas (opcionales pero útiles)
  guias     Guia[] @relation("RutaGuia")
  robots    RobotAutomatico[] @relation("RobotRutaActual")
  asistentes AsistentedeVoz[] @relation("AsistenteRutaActual")
}

model Mapa {
  id        Int      @id @default(autoincrement())
  name      String
  points    Json
  url       String
}

model Guia {
  id          Int      @id @default(autoincrement())
  id_ruta     Int
  puntoActual Int      @default(0)  // Valor predeterminado
  id_robot    Int
  
  // Hacer las relaciones opcionales o asegurar valores iniciales
  ruta        Route?          @relation(fields: [id_ruta], references: [id], name: "RutaGuia")
  robot       RobotAutomatico @relation(fields: [id_robot], references: [id], name: "RobotGuia")
  
  // Índices para mejor rendimiento
  @@index([id_ruta])
  @@index([id_robot])
}

model Dispositivo {
  id                 Int               @id @default(autoincrement())
  lat                Float
  lng                Float
  cardinalDirection  Float
  
  // Referencia inversa OPCIONAL
  robotId            Int?              @unique
  robot              RobotAutomatico?  @relation(fields: [robotId], references: [id])
  
  @@index([robotId])
}
model AsistentedeVoz {
  id                Int               @id @default(autoincrement())
  ubicacion         Ubicaciones
  estado            EstadoRobot       @default(LIBRE)
  id_rutaActual     Int?
  
  robots            RobotAutomatico[] @relation("AsistenteRobot")
  rutaActual        Route?            @relation(fields: [id_rutaActual], references: [id], name: "AsistenteRutaActual")
}

model RobotAutomatico {
  id                Int               @id @default(autoincrement())
  estado            EstadoRobot       @default(LIBRE)
  clienteID         String
  batteryLevel      Int?              @default(100)
  id_rutaActual     Int?
  
  // Relación 1:1 con dispositivo
  dispositivo       Dispositivo?    
  
  asistentes        AsistentedeVoz[]  @relation("AsistenteRobot")
  rutaActual        Route?            @relation(fields: [id_rutaActual], references: [id], name: "RobotRutaActual")
  guias             Guia[]            @relation("RobotGuia")
  
  @@index([clienteID])
  @@index([id_rutaActual])
}